#!/bin/sh -e

err(){
    echo "Unable to find the '$1' command."
    echo "Install from PyPI, using '${PREFIX}pip install $1'."
    exit 1
}

export PACKAGE="httpx"
export VERSION=$(grep __version__ "${PACKAGE}/__version__.py" | sed "s/__version__ = //" | sed "s/'//g")
export PREFIX=""
if [ -d 'venv' ] ; then
    export PREFIX="venv/bin/"
fi

scripts/clean

if ! command -v "${PREFIX}twine" > /dev/null 2>&1 ; then
    err twine
fi

if ! ${PREFIX}pip show wheel > /dev/null 2>&1; then
    err wheel
fi

if ! command -v "${PREFIX}mkdocs" > /dev/null 2>&1; then
    err mkdocs
fi

find ${PACKAGE} -type f -name "*.py[co]" -delete
find ${PACKAGE} -type d -name __pycache__ -delete

${PREFIX}python setup.py sdist bdist_wheel
${PREFIX}twine upload dist/*
${PREFIX}mkdocs gh-deploy

echo "You probably want to also tag the version now:"
echo "git tag -a ${VERSION} -m 'version ${VERSION}'"
echo "git push --tags"

scripts/clean
